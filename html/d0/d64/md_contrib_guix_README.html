<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bitcoin: Bootstrappable Bitcoin Core Builds</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bitcoin
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Bootstrappable Bitcoin Core Builds </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This directory contains the files necessary to perform bootstrappable Bitcoin Core builds.</p>
<p><a href="http://bootstrappable.org/">Bootstrappability</a> furthers our binary security guarantees by allowing us to <em>audit and reproduce</em> our toolchain instead of blindly <em>trusting</em> binary downloads.</p>
<p>We achieve bootstrappability by using Guix as a functional package manager.</p>
<h2>Requirements</h2>
<p>Conservatively, a x86_64 machine with:</p>
<ul>
<li>2 or more logical cores</li>
<li>4GB of free disk space on the partition that /gnu/store will reside in</li>
<li>24GB of free disk space on the partition that the Bitcoin Core git repository resides in</li>
</ul>
<blockquote class="doxtable">
<p>Note: these requirements are slightly less onerous than those of Gitian builds </p>
</blockquote>
<h2>Setup</h2>
<h3>Installing Guix</h3>
<p>If you're just testing this out, you can use the <a href="https://github.com/fanquake/core-review/tree/master/guix">Dockerfile</a> for convenience. It automatically speeds up your builds by <a href="../../#speeding-up-builds-with-substitute-servers">using substitutes</a>. If you don't want this behaviour, refer to the <a href="../../#choosing-your-security-model">next section</a>.</p>
<p>Otherwise, follow the <a href="https://www.gnu.org/software/guix/manual/en/html_node/Binary-Installation.html">Guix installation guide</a>.</p>
<blockquote class="doxtable">
<p>Note: For those who like to keep their filesystems clean, Guix is designed to be very standalone and <em>will not</em> conflict with your system's package manager/existing setup. It <em>only</em> touches <code>/var/guix</code>, <code>/gnu</code>, and <code>~/.config/guix</code>. </p>
</blockquote>
<h3>Choosing your security model</h3>
<p>Guix allows us to achieve better binary security by using our CPU time to build everything from scratch. However, it doesn't sacrifice user choice in pursuit of this: users can decide whether or not to bootstrap and to use substitutes.</p>
<p>After installation, you may want to consider <a href="../../#speeding-up-builds-with-substitute-servers">adding substitute servers</a> to speed up your build if that fits your security model (say, if you're just testing that this works). This is skippable if you're using the <a href="https://github.com/fanquake/core-review/tree/master/guix">Dockerfile</a>.</p>
<p>If you prefer not to use any substitutes, make sure to set <code>ADDITIONAL_GUIX_ENVIRONMENT_FLAGS</code> like the following snippet. The first build will take a while, but the resulting packages will be cached for future builds.</p>
<div class="fragment"><div class="line">export ADDITIONAL_GUIX_ENVIRONMENT_FLAGS=&#39;--no-substitutes&#39;</div></div><!-- fragment --><p>Likewise, to perform a bootstrapped build (takes even longer):</p>
<div class="fragment"><div class="line">export ADDITIONAL_GUIX_ENVIRONMENT_FLAGS=&#39;--bootstrap --no-substitutes&#39;</div></div><!-- fragment --><h3>Using the right Guix</h3>
<p>Once Guix is installed, deploy our patched version into your current Guix profile. The changes there are slowly being upstreamed.</p>
<div class="fragment"><div class="line">guix pull --url=https://github.com/dongcarl/guix.git \</div><div class="line">          --commit=82c77e52b8b46e0a3aad2cb12307c2e30547deec \</div><div class="line">          --max-jobs=4 # change accordingly</div></div><!-- fragment --><p>Make sure that you are using your current profile. (You are prompted to do this at the end of the <code>guix pull</code>)</p>
<div class="fragment"><div class="line">export PATH=&quot;${HOME}/.config/guix/current/bin${PATH:+:}$PATH&quot;</div></div><!-- fragment --><blockquote class="doxtable">
<p>Note: There is ongoing work to eliminate this entire section using Guix <a href="https://www.gnu.org/software/guix/manual/en/html_node/Inferiors.html">inferiors</a> and <a href="https://www.gnu.org/software/guix/manual/en/html_node/Channels.html">channels</a>. </p>
</blockquote>
<h2>Usage</h2>
<h3>As a Development Environment</h3>
<p>For a Bitcoin Core depends development environment, simply invoke</p>
<div class="fragment"><div class="line">guix environment --manifest=contrib/guix/manifest.scm</div></div><!-- fragment --><p>And you'll land back in your shell with all the build dependencies required for a <code>depends</code> build injected into your environment.</p>
<h3>As a Tool for Deterministic Builds</h3>
<p>From the top of a clean Bitcoin Core repository:</p>
<div class="fragment"><div class="line">./contrib/guix/guix-build.sh</div></div><!-- fragment --><p>After the build finishes successfully (check the status code please), compare hashes:</p>
<div class="fragment"><div class="line">find output/ -type f -print0 | sort -z | xargs -r0 sha256sum</div></div><!-- fragment --><h4>Recognized environment variables</h4>
<ul>
<li><p class="startli"><em><b>HOSTS</b></em></p>
<p class="startli">Override the space-separated list of platform triples for which to perform a bootstrappable build. _(defaults to "i686-linux-gnu x86\_64-linux-gnu
  arm-linux-gnueabihf aarch64-linux-gnu riscv64-linux-gnu")_</p>
</li>
</ul>
<blockquote class="doxtable">
<p>Windows and OS X platform triplet support are WIP. </p>
</blockquote>
<ul>
<li><p class="startli"><em><b>SOURCES_PATH</b></em></p>
<p class="startli">Set the depends tree download cache for sources. This is passed through to the depends tree. Setting this to the same directory across multiple builds of the depends tree can eliminate unnecessary redownloading of package sources.</p>
</li>
<li><p class="startli"><em><b>MAX_JOBS</b></em></p>
<p class="startli">Override the maximum number of jobs to run simultaneously, you might want to do so on a memory-limited machine. This may be passed to <code>make</code> as in <code>make --jobs="$MAX_JOBS"</code> or <code>xargs</code> as in <code>xargs -P"$MAX_JOBS"</code>. _(defaults to the value of <code>nproc</code> outside the container)_</p>
</li>
<li><p class="startli"><em><b>SOURCE_DATE_EPOCH</b></em></p>
<p class="startli">Override the reference UNIX timestamp used for bit-for-bit reproducibility, the variable name conforms to <a href="https://reproducible-builds.org/docs/source-date-epoch/">standard</a>. _(defaults to the output of <code>$(git log --format=at -1)</code>)_</p>
</li>
<li><p class="startli"><em><b>V</b></em></p>
<p class="startli">If non-empty, will pass <code>V=1</code> to all <code>make</code> invocations, making <code>make</code> output verbose.</p>
</li>
<li><p class="startli"><em><b>ADDITIONAL_GUIX_ENVIRONMENT_FLAGS</b></em></p>
<p class="startli">Additional flags to be passed to <code>guix environment</code>. For a fully-bootstrapped build, set this to <code>--bootstrap --no-substitutes</code> (refer to the <a href="../../#choosing-your-security-model">security model section</a> for more details). Note that a fully-bootstrapped build will take quite a long time on the first run.</p>
</li>
</ul>
<h2>Tips and Tricks</h2>
<h3>Speeding up builds with substitute servers</h3>
<p><em>This whole section is automatically done in the convenience <a href="https://github.com/fanquake/core-review/tree/master/guix">Dockerfiles</a></em></p>
<p>For those who are used to life in the fast _(and trustful)_ lane, you can use <a href="https://www.gnu.org/software/guix/manual/en/html_node/Substitutes.html">substitute servers</a> to enable binary downloads of packages.</p>
<blockquote class="doxtable">
<p>For those who only want to use substitutes from the official Guix build farm and have authorized the build farm's signing key during Guix's installation, you don't need to do anything. </p>
</blockquote>
<h4>Authorize the signing keys</h4>
<p>For the official Guix build farm at <a href="https://ci.guix.gnu.org,">https://ci.guix.gnu.org,</a> run as root:</p>
<div class="fragment"><div class="line">guix archive --authorize &lt; ~root/.config/guix/current/share/guix/ci.guix.gnu.org.pub</div></div><!-- fragment --><p>For dongcarl's substitute server at <a href="https://guix.carldong.io,">https://guix.carldong.io,</a> run as root:</p>
<div class="fragment"><div class="line">wget -qO- &#39;https://guix.carldong.io/signing-key.pub&#39; | guix archive --authorize</div></div><!-- fragment --><h4>Use the substitute servers</h4>
<p>The official Guix build farm at <a href="https://ci.guix.gnu.org">https://ci.guix.gnu.org</a> is automatically used unless the <code>--no-substitutes</code> flag is supplied.</p>
<p>This can be overridden for all <code>guix</code> invocations by passing the <code>--substitute-urls</code> option to your invocation of <code>guix-daemon</code>. This can also be overridden on a call-by-call basis by passing the same <code>--substitute-urls</code> option to client tools such at <code>guix environment</code>.</p>
<p>To use dongcarl's substitute server for Bitcoin Core builds after having <a href="../../#authorize-the-signing-keys">authorized his signing key</a>:</p>
<div class="fragment"><div class="line">export ADDITIONAL_GUIX_ENVIRONMENT_FLAGS=&#39;--substitute-urls=&quot;https://guix.carldong.io https://ci.guix.gnu.org&quot;&#39;</div></div><!-- fragment --><h2>FAQ</h2>
<h3>How can I trust the binary installation?</h3>
<p>As mentioned at the bottom of <a href="https://www.gnu.org/software/guix/manual/en/html_node/Binary-Installation.html">this manual page</a>:</p>
<blockquote class="doxtable">
<p>The binary installation tarballs can be (re)produced and verified simply by running the following command in the Guix source tree: </p><pre class="fragment">make guix-binary.x86_64-linux.tar.xz
</pre> </blockquote>
<h3>When will Guix be packaged in debian?</h3>
<p>Vagrant Cascadian has been making good progress on this <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=850644">here</a>. We have all the pieces needed to put up an APT repository and will likely put one up soon. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
