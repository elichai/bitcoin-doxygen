<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bitcoin: macOS Build Instructions and Notes</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bitcoin
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">macOS Build Instructions and Notes </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The commands in this guide should be executed in a Terminal application. The built-in one is located in </p><div class="fragment"><div class="line">/Applications/Utilities/Terminal.app</div></div><!-- fragment --><h2>Preparation</h2>
<p>Install the macOS command line tools:</p>
<div class="fragment"><div class="line">xcode-select --install</div></div><!-- fragment --><p>When the popup appears, click <code>Install</code>.</p>
<p>Then install <a href="https://brew.sh">Homebrew</a>.</p>
<p>## Dependencies </p><div class="fragment"><div class="line">brew install automake berkeley-db4 libtool boost miniupnpc openssl pkg-config protobuf python qt libevent qrencode</div></div><!-- fragment --><p>See <a class="el" href="../../de/dcd/dependencies_8md.html">dependencies.md</a> for a complete overview.</p>
<p>If you want to build the disk image with <code>make deploy</code> (.dmg / optional), you need RSVG: </p><div class="fragment"><div class="line">brew install librsvg</div></div><!-- fragment --><h2>Berkeley DB</h2>
<p>It is recommended to use Berkeley DB 4.8. If you have to build it yourself, you can use <a href="../..//contrib/install_db4.sh">this</a> script to install it like so:</p>
<div class="fragment"><div class="line">./contrib/install_db4.sh .</div></div><!-- fragment --><p>from the root of the repository.</p>
<p><b>Note</b>: You only need Berkeley DB if the wallet is enabled (see <a href="../..//doc/build-osx.md#disable-wallet-mode"><em>Disable-wallet mode</em></a>).</p>
<h2>Build Bitcoin Core</h2>
<ol type="1">
<li>Clone the Bitcoin Core source code: ```shell git clone <a href="https://github.com/bitcoin/bitcoin">https://github.com/bitcoin/bitcoin</a> cd bitcoin ```</li>
<li><p class="startli">Build Bitcoin Core:</p>
<p class="startli">Configure and build the headless Bitcoin Core binaries as well as the GUI (if Qt is found).</p>
<p class="startli">You can disable the GUI build by passing <code>--without-gui</code> to configure. ```shell ./autogen.sh ./configure make ```</p>
</li>
<li>It is recommended to build and run the unit tests: ```shell make check ```</li>
<li>You can also create a <code>.dmg</code> that contains the <code>.app</code> bundle (optional): ```shell make deploy ```</li>
</ol>
<h2><code>disable-wallet</code> mode</h2>
<p>When the intention is to run only a P2P node without a wallet, Bitcoin Core may be compiled in <code>disable-wallet</code> mode with: </p><div class="fragment"><div class="line">./configure --disable-wallet</div></div><!-- fragment --><p>In this case there is no dependency on Berkeley DB 4.8.</p>
<p>Mining is also possible in disable-wallet mode using the <code>getblocktemplate</code> RPC call.</p>
<h2>Running</h2>
<p>Bitcoin Core is now available at <code>./src/bitcoind</code></p>
<p>Before running, you may create an empty configuration file: </p><div class="fragment"><div class="line">mkdir -p &quot;/Users/${USER}/Library/Application Support/Bitcoin&quot;</div><div class="line"></div><div class="line">touch &quot;/Users/${USER}/Library/Application Support/Bitcoin/bitcoin.conf&quot;</div><div class="line"></div><div class="line">chmod 600 &quot;/Users/${USER}/Library/Application Support/Bitcoin/bitcoin.conf&quot;</div></div><!-- fragment --><p>The first time you run bitcoind, it will start downloading the blockchain. This process could take many hours, or even days on slower than average systems.</p>
<p>You can monitor the download process by looking at the debug.log file: </p><div class="fragment"><div class="line">tail -f $HOME/Library/Application\ Support/Bitcoin/debug.log</div></div><!-- fragment --><p>## Other commands: </p><div class="fragment"><div class="line">./src/bitcoind -daemon      # Starts the bitcoin daemon.</div><div class="line">./src/bitcoin-cli --help    # Outputs a list of command-line options.</div><div class="line">./src/bitcoin-cli help      # Outputs a list of RPC commands when the daemon is running.</div></div><!-- fragment --><h2>Notes</h2>
<ul>
<li>Tested on OS X 10.10 Yosemite through macOS 10.14 Mojave on 64-bit Intel processors only.</li>
<li>Building with downloaded Qt binaries is not officially supported. See the notes in <a href="https://github.com/bitcoin/bitcoin/issues/7714">#7714</a>.</li>
</ul>
<h2>Deterministic macOS DMG Notes</h2>
<p>Working macOS DMGs are created in Linux by combining a recent <code>clang</code>, the Apple <code>binutils</code> (<code>ld</code>, <code>ar</code>, etc) and DMG authoring tools.</p>
<p>Apple uses <code>clang</code> extensively for development and has upstreamed the necessary functionality so that a vanilla clang can take advantage. It supports the use of <code>-F</code>, <code>-target</code>, <code>-mmacosx-version-min</code>, and <code>--sysroot</code>, which are all necessary when building for macOS.</p>
<p>Apple's version of <code>binutils</code> (called <code>cctools</code>) contains lots of functionality missing in the FSF's <code>binutils</code>. In addition to extra linker options for frameworks and sysroots, several other tools are needed as well such as <code>install_name_tool</code>, <code>lipo</code>, and <code>nmedit</code>. These do not build under Linux, so they have been patched to do so. The work here was used as a starting point: <a href="https://github.com/mingwandroid/toolchain4">mingwandroid/toolchain4</a>.</p>
<p>In order to build a working toolchain, the following source packages are needed from Apple: <code>cctools</code>, <code>dyld</code>, and <code>ld64</code>.</p>
<p>These tools inject timestamps by default, which produce non-deterministic binaries. The <code>ZERO_AR_DATE</code> environment variable is used to disable that.</p>
<p>This version of <code>cctools</code> has been patched to use the current version of <code>clang</code>'s headers and its <code>libLTO.so</code> rather than those from <code>llvmgcc</code>, as it was originally done in <code>toolchain4</code>.</p>
<p>To complicate things further, all builds must target an Apple SDK. These SDKs are free to download, but not redistributable. To obtain it, register for an Apple Developer Account, then download the <a href="https://developer.apple.com/devcenter/download.action?path=/Developer_Tools/Xcode_7.3.1/Xcode_7.3.1.dmg">Xcode 7.3.1 dmg</a>.</p>
<p>This file is several gigabytes in size, but only a single directory inside is needed: </p><div class="fragment"><div class="line">Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.11.sdk</div></div><!-- fragment --><p>Unfortunately, the usual Linux tools (7zip, hpmount, loopback mount) are incapable of opening this file. To create a tarball suitable for Gitian input, there are two options:</p>
<p>Using macOS, you can mount the DMG, and then create it with: </p><div class="fragment"><div class="line">hdiutil attach Xcode_7.3.1.dmg</div><div class="line">tar -C /Volumes/Xcode/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/ -czf MacOSX10.11.sdk.tar.gz MacOSX10.11.sdk</div></div><!-- fragment --><p>Alternatively, you can use 7zip and SleuthKit to extract the files one by one. The script <a href="../.././../contrib/macdeploy/extract-osx-sdk.sh"><code>extract-osx-sdk.sh</code></a> automates this. First ensure the DMG file is in the current directory, and then run the script. You may wish to delete the <code>intermediate 5.hfs</code> file and <code>MacOSX10.11.sdk</code> (the directory) when you've confirmed the extraction succeeded.</p>
<div class="fragment"><div class="line">apt-get install p7zip-full sleuthkit</div><div class="line">contrib/macdeploy/extract-osx-sdk.sh</div><div class="line">rm -rf 5.hfs MacOSX10.11.sdk</div></div><!-- fragment --><p>The Gitian descriptors build 2 sets of files: Linux tools, then Apple binaries which are created using these tools. The build process has been designed to avoid including the SDK's files in Gitian's outputs. All interim tarballs are fully deterministic and may be freely redistributed.</p>
<p><code>genisoimage</code> is used to create the initial DMG. It is not deterministic as-is, so it has been patched. A system <code>genisoimage</code> will work fine, but it will not be deterministic because the file-order will change between invocations. The patch can be seen here: <a href="https://raw.githubusercontent.com/theuni/osx-cross-depends/master/patches/cdrtools/genisoimage.diff">theuni/osx-cross-depends</a>. No effort was made to fix this cleanly, so it likely leaks memory badly. But it's only used for a single invocation, so that's no real concern.</p>
<p><code>genisoimage</code> cannot compress DMGs, so afterwards, the DMG tool from the <code>libdmg-hfsplus</code> project is used to compress it. There are several bugs in this tool and its maintainer has seemingly abandoned the project. It has been forked and is available (with fixes) here: <a href="https://github.com/theuni/libdmg-hfsplus">theuni/libdmg-hfsplus</a>.</p>
<p>The DMG tool has the ability to create DMGs from scratch as well, but this functionality is broken. Only the compression feature is currently used. Ideally, the creation could be fixed and <code>genisoimage</code> would no longer be necessary.</p>
<p>Background images and other features can be added to DMG files by inserting a <code>.DS_Store</code> before creation. This is generated by the script <code><a class="el" href="../../d4/dda/custom__dsstore_8py.html">contrib/macdeploy/custom_dsstore.py</a></code>.</p>
<p>As of OS X 10.9 Mavericks, using an Apple-blessed key to sign binaries is a requirement in order to satisfy the new Gatekeeper requirements. Because this private key cannot be shared, we'll have to be a bit creative in order for the build process to remain somewhat deterministic. Here's how it works:</p>
<ul>
<li>Builders use Gitian to create an unsigned release. This outputs an unsigned DMG which users may choose to bless and run. It also outputs an unsigned app structure in the form of a tarball, which also contains all of the tools that have been previously (deterministically) built in order to create a final DMG.</li>
<li>The Apple keyholder uses this unsigned app to create a detached signature, using the script that is also included there. Detached signatures are available from this <a href="https://github.com/bitcoin-core/bitcoin-detached-sigs">repository</a>.</li>
<li>Builders feed the unsigned app + detached signature back into Gitian. It uses the pre-built tools to recombine the pieces into a deterministic DMG. </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
