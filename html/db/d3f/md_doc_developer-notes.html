<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bitcoin: Developer Notes</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bitcoin
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Developer Notes </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Table of Contents</b></p>
<ul>
<li><a href="../../#developer-notes">Developer Notes</a><ul>
<li><a href="../../#coding-style-general">Coding Style (General)</a></li>
<li><a href="../../#coding-style-c">Coding Style (C++)</a></li>
<li><a href="../../#coding-style-python">Coding Style (Python)</a></li>
<li><a href="../../#coding-style-doxygen-compatible-comments">Coding Style (Doxygen-compatible comments)</a></li>
<li><a href="../../#development-tips-and-tricks">Development tips and tricks</a><ul>
<li><a href="../../#compiling-for-debugging">Compiling for debugging</a></li>
<li><a href="../../#compiling-for-gprof-profiling">Compiling for gprof profiling</a></li>
<li><a href="../../#debuglog">debug.log</a></li>
<li><a href="../../#testnet-and-regtest-modes">Testnet and Regtest modes</a></li>
<li><a href="../../#debug_lockorder">DEBUG_LOCKORDER</a></li>
<li><a href="../../#valgrind-suppressions-file">Valgrind suppressions file</a></li>
<li><a href="../../#compiling-for-test-coverage">Compiling for test coverage</a></li>
<li><a href="../../#performance-profiling-with-perf">Performance profiling with perf</a></li>
</ul>
</li>
<li><a href="../../#lockingmutex-usage-notes">Locking/mutex usage notes</a></li>
<li><a href="../../#threads">Threads</a></li>
<li><a href="../../#ignoring-ideeditor-files">Ignoring IDE/editor files</a></li>
</ul>
</li>
<li><a href="../../#development-guidelines">Development guidelines</a><ul>
<li><a href="../../#general-bitcoin-core">General Bitcoin Core</a></li>
<li><a href="../../#wallet">Wallet</a></li>
<li><a href="../../#general-c">General C++</a></li>
<li><a href="../../#c-data-structures">C++ data structures</a></li>
<li><a href="../../#strings-and-formatting">Strings and formatting</a></li>
<li><a href="../../#variable-names">Variable names</a></li>
<li><a href="../../#threads-and-synchronization">Threads and synchronization</a></li>
<li><a href="../../#scripts">Scripts</a><ul>
<li><a href="../../#shebang">Shebang</a></li>
</ul>
</li>
<li><a href="../../#source-code-organization">Source code organization</a></li>
<li><a href="../../#gui">GUI</a></li>
<li><a href="../../#subtrees">Subtrees</a></li>
<li><a href="../../#scripted-diffs">Scripted diffs</a></li>
<li><a href="../../#release-notes">Release notes</a></li>
<li><a href="../../#rpc-interface-guidelines">RPC interface guidelines</a></li>
</ul>
</li>
</ul>
<h2>Coding Style (General) </h2>
<p>Various coding styles have been used during the history of the codebase, and the result is not very consistent. However, we're now trying to converge to a single style, which is specified below. When writing patches, favor the new style over attempting to mimic the surrounding style, except for move-only commits.</p>
<p>Do not submit patches solely to modify the style of existing code.</p>
<h2>Coding Style (C++) </h2>
<ul>
<li><b>Indentation and whitespace rules</b> as specified in <a href="../..//src/.clang-format">src/.clang-format</a>. You can use the provided <a href="../..//contrib/devtools/README.md#clang-format-diffpy">clang-format-diff script</a> tool to clean up patches automatically before submission.<ul>
<li>Braces on new lines for classes, functions, methods.</li>
<li>Braces on the same line for everything else.</li>
<li>4 space indentation (no tabs) for every block except namespaces.</li>
<li>No indentation for <code>public</code>/<code>protected</code>/<code>private</code> or for <code>namespace</code>.</li>
<li>No extra spaces inside parenthesis; don't do ( this )</li>
<li>No space after function names; one space after <code>if</code>, <code>for</code> and <code>while</code>.</li>
<li>If an <code>if</code> only has a single-statement <code>then</code>-clause, it can appear on the same line as the <code>if</code>, without braces. In every other case, braces are required, and the <code>then</code> and <code>else</code> clauses must appear correctly indented on a new line.</li>
</ul>
</li>
<li><b>Symbol naming conventions</b>. These are preferred in new code, but are not required when doing so would need changes to significant pieces of existing code.<ul>
<li>Variable (including function arguments) and namespace names are all lowercase, and may use <code>_</code> to separate words (snake_case).<ul>
<li>Class member variables have a <code>m_</code> prefix.</li>
<li>Global variables have a <code>g_</code> prefix.</li>
</ul>
</li>
<li>Constant names are all uppercase, and use <code>_</code> to separate words.</li>
<li>Class names, function names and method names are UpperCamelCase (PascalCase). Do not prefix class names with <code>C</code>.</li>
<li>Test suite naming convention: The Boost test suite in file <code>src/test/foo_tests.cpp</code> should be named <code>foo_tests</code>. Test suite names must be unique.</li>
</ul>
</li>
<li><b>Miscellaneous</b><ul>
<li><code>++i</code> is preferred over <code>i++</code>.</li>
<li><code>nullptr</code> is preferred over <code>NULL</code> or <code>(void*)0</code>.</li>
<li><code>static_assert</code> is preferred over <code>assert</code> where possible. Generally; compile-time checking is preferred over run-time checking.</li>
<li><code>enum class</code> is preferred over <code>enum</code> where possible. Scoped enumerations avoid two potential pitfalls/problems with traditional C++ enumerations: implicit conversions to int, and name clashes due to enumerators being exported to the surrounding scope.</li>
</ul>
</li>
</ul>
<p>Block style example: </p><div class="fragment"><div class="line"> {c++}</div><div class="line">int g_count = 0;</div><div class="line"></div><div class="line">namespace foo {</div><div class="line">class Class</div><div class="line">{</div><div class="line">    std::string m_name;</div><div class="line"></div><div class="line">public:</div><div class="line">    bool Function(const std::string&amp; s, int n)</div><div class="line">    {</div><div class="line">        // Comment summarising what this section of code does</div><div class="line">        for (int i = 0; i &lt; n; ++i) {</div><div class="line">            int total_sum = 0;</div><div class="line">            // When something fails, return early</div><div class="line">            if (!Something()) return false;</div><div class="line">            ...</div><div class="line">            if (SomethingElse(i)) {</div><div class="line">                total_sum += ComputeSomething(g_count);</div><div class="line">            } else {</div><div class="line">                DoSomething(m_name, total_sum);</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        // Success return is usually at the end</div><div class="line">        return true;</div><div class="line">    }</div><div class="line">}</div><div class="line">} // namespace foo</div></div><!-- fragment --><h2>Coding Style (Python) </h2>
<p>Refer to <a href="../..//test/functional/README.md#style-guidelines">/test/functional/README.md::style-guidelines</a>.</p>
<h2>Coding Style (Doxygen-compatible comments) </h2>
<p>Bitcoin Core uses <a href="http://www.doxygen.nl/">Doxygen</a> to generate its official documentation.</p>
<p>Use Doxygen-compatible comment blocks for functions, methods, and fields.</p>
<p>For example, to describe a function use: </p><div class="fragment"><div class="line"> {c++}</div><div class="line">/**</div><div class="line"> * ... text ...</div><div class="line"> * @param[in] arg1    A description</div><div class="line"> * @param[in] arg2    Another argument description</div><div class="line"> * @pre Precondition for function...</div><div class="line"> */</div><div class="line">bool function(int arg1, const char *arg2)</div></div><!-- fragment --><p> A complete list of <code>@xxx</code> commands can be found at <a href="http://www.doxygen.nl/manual/commands.html">http://www.doxygen.nl/manual/commands.html</a>. As Doxygen recognizes the comments by the delimiters (<code>/**</code> and <code>*/</code> in this case), you don't <em>need</em> to provide any commands for a comment to be valid; just a description text is fine.</p>
<p>To describe a class use the same construct above the class definition: </p><div class="fragment"><div class="line"> {c++}</div><div class="line">/**</div><div class="line"> * Alerts are for notifying old versions if they become too obsolete and</div><div class="line"> * need to upgrade. The message is displayed in the status bar.</div><div class="line"> * @see GetWarnings()</div><div class="line"> */</div><div class="line">class CAlert</div><div class="line">{</div></div><!-- fragment --><p>To describe a member or variable use: </p><div class="fragment"><div class="line"> {c++}</div><div class="line">int var; //!&lt; Detailed description after the member</div></div><!-- fragment --><p>or </p><div class="fragment"><div class="line"> {c++}</div><div class="line">//! Description before the member</div><div class="line">int var;</div></div><!-- fragment --><p>Also OK: </p><div class="fragment"><div class="line"> {c++}</div><div class="line">///</div><div class="line">/// ... text ...</div><div class="line">///</div><div class="line">bool function2(int arg1, const char *arg2)</div></div><!-- fragment --><p>Not OK (used plenty in the current source, but not picked up): </p><div class="fragment"><div class="line"> {c++}</div><div class="line">//</div><div class="line">// ... text ...</div><div class="line">//</div></div><!-- fragment --><p>A full list of comment syntaxes picked up by Doxygen can be found at <a href="http://www.doxygen.nl/manual/docblocks.html,">http://www.doxygen.nl/manual/docblocks.html,</a> but the above styles are favored.</p>
<p>Documentation can be generated with <code>make docs</code> and cleaned up with <code>make clean-docs</code>. The resulting files are located in <code>doc/doxygen/html</code>; open <code>index.html</code> to view the homepage.</p>
<p>Before running <code>make docs</code>, you will need to install dependencies <code>doxygen</code> and <code>dot</code>. For example, on MacOS via Homebrew: </p><div class="fragment"><div class="line">brew install doxygen --with-graphviz</div></div><!-- fragment --><h2>Development tips and tricks </h2>
<h3>Compiling for debugging</h3>
<p>Run configure with <code>--enable-debug</code> to add additional compiler flags that produce better debugging builds.</p>
<h3>Compiling for gprof profiling</h3>
<p>Run configure with the <code>--enable-gprof</code> option, then make.</p>
<h3>debug.log</h3>
<p>If the code is behaving strangely, take a look in the debug.log file in the data directory; error and debugging messages are written there.</p>
<p>The <code>-debug=...</code> command-line option controls debugging; running with just <code>-debug</code> or <code>-debug=1</code> will turn on all categories (and give you a very large debug.log file).</p>
<p>The Qt code routes <code>qDebug()</code> output to debug.log under category "qt": run with <code>-debug=qt</code> to see it.</p>
<h3>Testnet and Regtest modes</h3>
<p>Run with the <code>-testnet</code> option to run with "play bitcoins" on the test network, if you are testing multi-machine code that needs to operate across the internet.</p>
<p>If you are testing something that can run on one machine, run with the <code>-regtest</code> option. In regression test mode, blocks can be created on-demand; see <a href="../..//test/functional">test/functional/</a> for tests that run in <code>-regtest</code> mode.</p>
<h3>DEBUG_LOCKORDER</h3>
<p>Bitcoin Core is a multi-threaded application, and deadlocks or other multi-threading bugs can be very difficult to track down. The <code>--enable-debug</code> configure option adds <code>-DDEBUG_LOCKORDER</code> to the compiler flags. This inserts run-time checks to keep track of which locks are held, and adds warnings to the debug.log file if inconsistencies are detected.</p>
<h3>Valgrind suppressions file</h3>
<p>Valgrind is a programming tool for memory debugging, memory leak detection, and profiling. The repo contains a Valgrind suppressions file (<a href="https://github.com/bitcoin/bitcoin/blob/master/contrib/valgrind.supp"><code>valgrind.supp</code></a>) which includes known Valgrind warnings in our dependencies that cannot be fixed in-tree. Example use:</p>
<div class="fragment"><div class="line">$ valgrind --suppressions=contrib/valgrind.supp src/test/test_bitcoin</div><div class="line">$ valgrind --suppressions=contrib/valgrind.supp --leak-check=full \</div><div class="line">      --show-leak-kinds=all src/test/test_bitcoin --log_level=test_suite</div><div class="line">$ valgrind -v --leak-check=full src/bitcoind -printtoconsole</div></div><!-- fragment --><h3>Compiling for test coverage</h3>
<p>LCOV can be used to generate a test coverage report based upon <code>make check</code> execution. LCOV must be installed on your system (e.g. the <code>lcov</code> package on Debian/Ubuntu).</p>
<p>To enable LCOV report generation during test runs:</p>
<div class="fragment"><div class="line">./configure --enable-lcov</div><div class="line">make</div><div class="line">make cov</div><div class="line"></div><div class="line"># A coverage report will now be accessible at `./test_bitcoin.coverage/index.html`.</div></div><!-- fragment --><h3>Performance profiling with perf</h3>
<p>Profiling is a good way to get a precise idea of where time is being spent in code. One tool for doing profiling on Linux platforms is called <a href="http://www.brendangregg.com/perf.html"><code>perf</code></a>, and has been integrated into the functional test framework. Perf can observe a running process and sample (at some frequency) where its execution is.</p>
<p>Perf installation is contingent on which kernel version you're running; see <a href="https://askubuntu.com/questions/50145/how-to-install-perf-monitoring-tool">this StackExchange thread</a> for specific instructions.</p>
<p>Certain kernel parameters may need to be set for perf to be able to inspect the running process's stack.</p>
<div class="fragment"><div class="line">$ sudo sysctl -w kernel.perf_event_paranoid=-1</div><div class="line">$ sudo sysctl -w kernel.kptr_restrict=0</div></div><!-- fragment --><p>Make sure you <a href="https://lwn.net/Articles/420403/">understand the security trade-offs</a> of setting these kernel parameters.</p>
<p>To profile a running bitcoind process for 60 seconds, you could use an invocation of <code>perf record</code> like this:</p>
<div class="fragment"><div class="line">$ perf record \</div><div class="line">    -g --call-graph dwarf --per-thread -F 140 \</div><div class="line">    -p `pgrep bitcoind` -- sleep 60</div></div><!-- fragment --><p>You could then analyze the results by running</p>
<div class="fragment"><div class="line">perf report --stdio | c++filt | less</div></div><!-- fragment --><p>or using a graphical tool like <a href="https://github.com/KDAB/hotspot">Hotspot</a>.</p>
<p>See the functional test documentation for how to invoke perf within tests.</p>
<p><b>Sanitizers</b></p>
<p>Bitcoin Core can be compiled with various "sanitizers" enabled, which add instrumentation for issues regarding things like memory safety, thread race conditions, or undefined behavior. This is controlled with the <code>--with-sanitizers</code> configure flag, which should be a comma separated list of sanitizers to enable. The sanitizer list should correspond to supported <code>-fsanitize=</code> options in your compiler. These sanitizers have runtime overhead, so they are most useful when testing changes or producing debugging builds.</p>
<p>Some examples:</p>
<div class="fragment"><div class="line"># Enable both the address sanitizer and the undefined behavior sanitizer</div><div class="line">./configure --with-sanitizers=address,undefined</div><div class="line"></div><div class="line"># Enable the thread sanitizer</div><div class="line">./configure --with-sanitizers=thread</div></div><!-- fragment --><p>If you are compiling with GCC you will typically need to install corresponding "san" libraries to actually compile with these flags, e.g. libasan for the address sanitizer, libtsan for the thread sanitizer, and libubsan for the undefined sanitizer. If you are missing required libraries, the configure script will fail with a linker error when testing the sanitizer flags.</p>
<p>The test suite should pass cleanly with the <code>thread</code> and <code>undefined</code> sanitizers, but there are a number of known problems when using the <code>address</code> sanitizer. The address sanitizer is known to fail in <a href="../..//src/crypto/sha256_sse4.cpp">sha256_sse4::Transform</a> which makes it unusable unless you also use <code>--disable-asm</code> when running configure. We would like to fix sanitizer issues, so please send pull requests if you can fix any errors found by the address sanitizer (or any other sanitizer).</p>
<p>Not all sanitizer options can be enabled at the same time, e.g. trying to build with <code>--with-sanitizers=address,thread</code> will fail in the configure script as these sanitizers are mutually incompatible. Refer to your compiler manual to learn more about these options and which sanitizers are supported by your compiler.</p>
<p>Additional resources:</p>
<ul>
<li><a href="https://clang.llvm.org/docs/AddressSanitizer.html">AddressSanitizer</a></li>
<li><a href="https://clang.llvm.org/docs/LeakSanitizer.html">LeakSanitizer</a></li>
<li><a href="https://clang.llvm.org/docs/MemorySanitizer.html">MemorySanitizer</a></li>
<li><a href="https://clang.llvm.org/docs/ThreadSanitizer.html">ThreadSanitizer</a></li>
<li><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html">UndefinedBehaviorSanitizer</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Instrumentation-Options.html">GCC Instrumentation Options</a></li>
<li><a href="https://github.com/google/sanitizers/wiki">Google Sanitizers Wiki</a></li>
<li><a href="https://github.com/bitcoin/bitcoin/issues/12691">Issue #12691: Enable -fsanitize flags in Travis</a></li>
</ul>
<h2>Locking/mutex usage notes </h2>
<p>The code is multi-threaded, and uses mutexes and the <code>LOCK</code> and <code>TRY_LOCK</code> macros to protect data structures.</p>
<p>Deadlocks due to inconsistent lock ordering (thread 1 locks <code>cs_main</code> and then <code>cs_wallet</code>, while thread 2 locks them in the opposite order: result, deadlock as each waits for the other to release its lock) are a problem. Compile with <code>-DDEBUG_LOCKORDER</code> (or use <code>--enable-debug</code>) to get lock order inconsistencies reported in the debug.log file.</p>
<p>Re-architecting the core code so there are better-defined interfaces between the various components is a goal, with any necessary locking done by the components (e.g. see the self-contained <code><a class="el" href="../../d5/dca/classCBasicKeyStore.html">CBasicKeyStore</a></code> class and its <code>cs_KeyStore</code> lock for example).</p>
<h2>Threads </h2>
<ul>
<li>ThreadScriptCheck : Verifies block scripts.</li>
<li>ThreadImport : Loads blocks from blk*.dat files or bootstrap.dat.</li>
<li>StartNode : Starts other threads.</li>
<li>ThreadDNSAddressSeed : Loads addresses of peers from the DNS.</li>
<li>ThreadMapPort : Universal plug-and-play startup/shutdown</li>
<li>ThreadSocketHandler : Sends/Receives data from peers on port 8333.</li>
<li>ThreadOpenAddedConnections : Opens network connections to added nodes.</li>
<li>ThreadOpenConnections : Initiates new connections to peers.</li>
<li>ThreadMessageHandler : Higher-level message handling (sending and receiving).</li>
<li>DumpAddresses : Dumps IP addresses of nodes to peers.dat.</li>
<li>ThreadRPCServer : Remote procedure call handler, listens on port 8332 for connections and services them.</li>
<li>Shutdown : Does an orderly shutdown of everything.</li>
</ul>
<h2>Ignoring IDE/editor files </h2>
<p>In closed-source environments in which everyone uses the same IDE it is common to add temporary files it produces to the project-wide <code>.gitignore</code> file.</p>
<p>However, in open source software such as Bitcoin Core, where everyone uses their own editors/IDE/tools, it is less common. Only you know what files your editor produces and this may change from version to version. The canonical way to do this is thus to create your local gitignore. Add this to <code>~/.gitconfig</code>:</p>
<div class="fragment"><div class="line">[core]</div><div class="line">        excludesfile = /home/.../.gitignore_global</div></div><!-- fragment --><p>(alternatively, type the command <code>git config --global core.excludesfile ~/.gitignore_global</code> on a terminal)</p>
<p>Then put your favourite tool's temporary filenames in that file, e.g. </p><div class="fragment"><div class="line"># NetBeans</div><div class="line">nbproject/</div></div><!-- fragment --><p>Another option is to create a per-repository excludes file <code>.git/info/exclude</code>. These are not committed but apply only to one repository.</p>
<p>If a set of tools is used by the build system or scripts the repository (for example, lcov) it is perfectly acceptable to add its files to <code>.gitignore</code> and commit them.</p>
<h1>Development guidelines </h1>
<p>A few non-style-related recommendations for developers, as well as points to pay attention to for reviewers of Bitcoin Core code.</p>
<h2>General Bitcoin Core </h2>
<ul>
<li>New features should be exposed on RPC first, then can be made available in the GUI<ul>
<li><em>Rationale</em>: RPC allows for better automatic testing. The test suite for the GUI is very limited</li>
</ul>
</li>
<li>Make sure pull requests pass Travis CI before merging<ul>
<li><em>Rationale</em>: Makes sure that they pass thorough testing, and that the tester will keep passing on the master branch. Otherwise all new pull requests will start failing the tests, resulting in confusion and mayhem</li>
<li><em>Explanation</em>: If the test suite is to be updated for a change, this has to be done first</li>
</ul>
</li>
</ul>
<h2>Wallet </h2>
<ul>
<li>Make sure that no crashes happen with run-time option <code>-disablewallet</code>.<ul>
<li><em>Rationale</em>: In RPC code that conditionally uses the wallet (such as <code>validateaddress</code>) it is easy to forget that global pointer <code>pwalletMain</code> can be nullptr. See <code>test/functional/disablewallet.py</code> for functional tests exercising the API with <code>-disablewallet</code></li>
</ul>
</li>
<li>Include <code>db_cxx.h</code> (BerkeleyDB header) only when <code>ENABLE_WALLET</code> is set<ul>
<li><em>Rationale</em>: Otherwise compilation of the disable-wallet build will fail in environments without BerkeleyDB</li>
</ul>
</li>
</ul>
<h2>General C++ </h2>
<p>For general C++ guidelines, you may refer to the <a href="https://isocpp.github.io/CppCoreGuidelines/">C++ Core Guidelines</a>.</p>
<p>Common misconceptions are clarified in those sections:</p>
<ul>
<li>Passing (non-)fundamental types in the <a href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rf-conventional">C++ Core Guideline</a></li>
<li>Assertions should not have side-effects<ul>
<li><em>Rationale</em>: Even though the source code is set to refuse to compile with assertions disabled, having side-effects in assertions is unexpected and makes the code harder to understand</li>
</ul>
</li>
<li>If you use the <code>.h</code>, you must link the <code>.cpp</code><ul>
<li><em>Rationale</em>: Include files define the interface for the code in implementation files. Including one but not linking the other is confusing. Please avoid that. Moving functions from the <code>.h</code> to the <code>.cpp</code> should not result in build errors</li>
</ul>
</li>
<li>Use the RAII (Resource Acquisition Is Initialization) paradigm where possible. For example by using <code>unique_ptr</code> for allocations in a function.<ul>
<li><em>Rationale</em>: This avoids memory and resource leaks, and ensures exception safety</li>
</ul>
</li>
<li>Use <code><a class="el" href="../../dc/d18/memory_8h.html#a745e9413ab61925e6534aefdbb97efb8" title="Substitute for C++14 std::make_unique.">MakeUnique()</a></code> to construct objects owned by <code>unique_ptr</code>s<ul>
<li><em>Rationale</em>: <code>MakeUnique</code> is concise and ensures exception safety in complex expressions. <code>MakeUnique</code> is a temporary project local implementation of <code>std::make_unique</code> (C++14).</li>
</ul>
</li>
</ul>
<h2>C++ data structures </h2>
<ul>
<li>Never use the <code>std::map []</code> syntax when reading from a map, but instead use <code>.find()</code><ul>
<li><em>Rationale</em>: <code>[]</code> does an insert (of the default element) if the item doesn't exist in the map yet. This has resulted in memory leaks in the past, as well as race conditions (expecting read-read behavior). Using <code>[]</code> is fine for <em>writing</em> to a map</li>
</ul>
</li>
<li>Do not compare an iterator from one data structure with an iterator of another data structure (even if of the same type)<ul>
<li><em>Rationale</em>: Behavior is undefined. In C++ parlor this means "may reformat
    the universe", in practice this has resulted in at least one hard-to-debug crash bug</li>
</ul>
</li>
<li>Watch out for out-of-bounds vector access. <code>&amp;vch[vch.size()]</code> is illegal, including <code>&amp;vch[0]</code> for an empty vector. Use <code><a class="el" href="../../d0/db6/namespaceanonymous__namespace_02bech32_8cpp_03.html#a04415a32bc824ad809dce1b63ca2f592">vch.data()</a></code> and <code><a class="el" href="../../d0/db6/namespaceanonymous__namespace_02bech32_8cpp_03.html#a04415a32bc824ad809dce1b63ca2f592">vch.data()</a> + vch.size()</code> instead.</li>
<li>Vector bounds checking is only enabled in debug mode. Do not rely on it</li>
<li>Initialize all non-static class members where they are defined. If this is skipped for a good reason (i.e., optimization on the critical path), add an explicit comment about this<ul>
<li><em>Rationale</em>: Ensure determinism by avoiding accidental use of uninitialized values. Also, static analyzers balk about this. Initializing the members in the declaration makes it easy to spot uninitialized ones.</li>
</ul>
</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">class </span>A</div><div class="line">{</div><div class="line">    <a class="code" href="../../df/dd8/stdint_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> m_count{0};</div><div class="line">}</div></div><!-- fragment --><ul>
<li>By default, declare single-argument constructors <code>explicit</code>.<ul>
<li><em>Rationale</em>: This is a precaution to avoid unintended conversions that might arise when single-argument constructors are used as implicit conversion functions.</li>
</ul>
</li>
<li>Use explicitly signed or unsigned <code>char</code>s, or even better <code>uint8_t</code> and <code>int8_t</code>. Do not use bare <code>char</code> unless it is to pass to a third-party API. This type can be signed or unsigned depending on the architecture, which can lead to interoperability problems or dangerous conditions such as out-of-bounds array accesses</li>
<li>Prefer explicit constructions over implicit ones that rely on 'magical' C++ behavior<ul>
<li><em>Rationale</em>: Easier to understand what is happening, thus easier to spot mistakes, even for those that are not language lawyers</li>
</ul>
</li>
</ul>
<h2>Strings and formatting </h2>
<ul>
<li>Be careful of <code>LogPrint</code> versus <code>LogPrintf</code>. <code>LogPrint</code> takes a <code>category</code> argument, <code>LogPrintf</code> does not.<ul>
<li><em>Rationale</em>: Confusion of these can result in runtime exceptions due to formatting mismatch, and it is easy to get wrong because of subtly similar naming</li>
</ul>
</li>
<li>Use <code>std::string</code>, avoid C string manipulation functions<ul>
<li><em>Rationale</em>: C++ string handling is marginally safer, less scope for buffer overflows and surprises with <code>\0</code> characters. Also some C string manipulations tend to act differently depending on platform, or even the user locale</li>
</ul>
</li>
<li>Use <code>ParseInt32</code>, <code>ParseInt64</code>, <code>ParseUInt32</code>, <code>ParseUInt64</code>, <code>ParseDouble</code> from <code>utilstrencodings.h</code> for number parsing<ul>
<li><em>Rationale</em>: These functions do overflow checking, and avoid pesky locale issues.</li>
</ul>
</li>
<li>Avoid using locale dependent functions if possible. You can use the provided <a href="../..//test/lint/lint-locale-dependence.sh"><code>lint-locale-dependence.sh</code></a> to check for accidental use of locale dependent functions.<ul>
<li><em>Rationale</em>: Unnecessary locale dependence can cause bugs that are very tricky to isolate and fix.</li>
<li>These functions are known to be locale dependent: <code>alphasort</code>, <code>asctime</code>, <code>asprintf</code>, <code>atof</code>, <code>atoi</code>, <code>atol</code>, <code>atoll</code>, <code>atoq</code>, <code>btowc</code>, <code>ctime</code>, <code>dprintf</code>, <code>fgetwc</code>, <code>fgetws</code>, <code>fprintf</code>, <code>fputwc</code>, <code>fputws</code>, <code>fscanf</code>, <code>fwprintf</code>, <code>getdate</code>, <code>getwc</code>, <code>getwchar</code>, <code>isalnum</code>, <code>isalpha</code>, <code>isblank</code>, <code>iscntrl</code>, <code>isdigit</code>, <code>isgraph</code>, <code>islower</code>, <code>isprint</code>, <code>ispunct</code>, <code>isspace</code>, <code>isupper</code>, <code>iswalnum</code>, <code>iswalpha</code>, <code>iswblank</code>, <code>iswcntrl</code>, <code>iswctype</code>, <code>iswdigit</code>, <code>iswgraph</code>, <code>iswlower</code>, <code>iswprint</code>, <code>iswpunct</code>, <code>iswspace</code>, <code>iswupper</code>, <code>iswxdigit</code>, <code>isxdigit</code>, <code>mblen</code>, <code>mbrlen</code>, <code>mbrtowc</code>, <code>mbsinit</code>, <code>mbsnrtowcs</code>, <code>mbsrtowcs</code>, <code>mbstowcs</code>, <code>mbtowc</code>, <code>mktime</code>, <code>putwc</code>, <code>putwchar</code>, <code>scanf</code>, <code>snprintf</code>, <code>sprintf</code>, <code>sscanf</code>, <code>stoi</code>, <code>stol</code>, <code>stoll</code>, <code>strcasecmp</code>, <code>strcasestr</code>, <code>strcoll</code>, <code>strfmon</code>, <code>strftime</code>, <code>strncasecmp</code>, <code>strptime</code>, <code>strtod</code>, <code>strtof</code>, <code>strtoimax</code>, <code>strtol</code>, <code>strtold</code>, <code>strtoll</code>, <code>strtoq</code>, <code>strtoul</code>, <code>strtoull</code>, <code>strtoumax</code>, <code>strtouq</code>, <code>strxfrm</code>, <code>swprintf</code>, <code>tolower</code>, <code>toupper</code>, <code>towctrans</code>, <code>towlower</code>, <code>towupper</code>, <code>ungetwc</code>, <code>vasprintf</code>, <code>vdprintf</code>, <code>versionsort</code>, <code>vfprintf</code>, <code>vfscanf</code>, <code>vfwprintf</code>, <code>vprintf</code>, <code>vscanf</code>, <code>vsnprintf</code>, <code>vsprintf</code>, <code>vsscanf</code>, <code>vswprintf</code>, <code>vwprintf</code>, <code>wcrtomb</code>, <code>wcscasecmp</code>, <code>wcscoll</code>, <code>wcsftime</code>, <code>wcsncasecmp</code>, <code>wcsnrtombs</code>, <code>wcsrtombs</code>, <code>wcstod</code>, <code>wcstof</code>, <code>wcstoimax</code>, <code>wcstol</code>, <code>wcstold</code>, <code>wcstoll</code>, <code>wcstombs</code>, <code>wcstoul</code>, <code>wcstoull</code>, <code>wcstoumax</code>, <code>wcswidth</code>, <code>wcsxfrm</code>, <code>wctob</code>, <code>wctomb</code>, <code>wctrans</code>, <code>wctype</code>, <code>wcwidth</code>, <code>wprintf</code></li>
</ul>
</li>
<li>For <code>strprintf</code>, <code>LogPrint</code>, <code>LogPrintf</code> formatting characters don't need size specifiers<ul>
<li><em>Rationale</em>: Bitcoin Core uses tinyformat, which is type safe. Leave them out to avoid confusion</li>
</ul>
</li>
</ul>
<h2>Variable names </h2>
<p>Although the shadowing warning (<code>-Wshadow</code>) is not enabled by default (it prevents issues rising from using a different variable with the same name), please name variables so that their names do not shadow variables defined in the source code.</p>
<p>E.g. in member initializers, prepend <code>_</code> to the argument name shadowing the member name:</p>
<div class="fragment"><div class="line"> {c++}</div><div class="line">class AddressBookPage</div><div class="line">{</div><div class="line">    Mode m_mode;</div><div class="line">}</div><div class="line"></div><div class="line">AddressBookPage::AddressBookPage(Mode _mode)</div><div class="line">    : m_mode(_mode)</div><div class="line">...</div></div><!-- fragment --><p>When using nested cycles, do not name the inner cycle variable the same as in upper cycle etc.</p>
<h2>Threads and synchronization </h2>
<ul>
<li>Build and run tests with <code>-DDEBUG_LOCKORDER</code> to verify that no potential deadlocks are introduced. As of 0.12, this is defined by default when configuring with <code>--enable-debug</code></li>
<li><p class="startli">When using <code>LOCK</code>/<code>TRY_LOCK</code> be aware that the lock exists in the context of the current scope, so surround the statement and the code that needs the lock with braces</p>
<p class="startli">OK:</p>
</li>
</ul>
<div class="fragment"><div class="line"> {c++}</div><div class="line">{</div><div class="line">    TRY_LOCK(cs_vNodes, lockNodes);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p>Wrong:</p>
<div class="fragment"><div class="line"> {c++}</div><div class="line">TRY_LOCK(cs_vNodes, lockNodes);</div><div class="line">{</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h2>Scripts </h2>
<h3>Shebang</h3>
<ul>
<li><p class="startli">Use <code>#!/usr/bin/env bash</code> instead of obsolete <code>#!/bin/bash</code>.</p><ul>
<li><p class="startli"><a href="https://github.com/dylanaraps/pure-bash-bible#shebang"><em>Rationale</em></a>:</p>
<p class="startli"><code>#!/bin/bash</code> assumes it is always installed to /bin/ which can cause issues;</p>
<p class="startli"><code>#!/usr/bin/env bash</code> searches the user's PATH to find the bash binary.</p>
</li>
</ul>
<p class="startli">OK:</p>
</li>
</ul>
<div class="fragment"><div class="line">#!/usr/bin/env bash</div></div><!-- fragment --><p>Wrong:</p>
<div class="fragment"><div class="line">#!/bin/bash</div></div><!-- fragment --><h2>Source code organization </h2>
<ul>
<li>Implementation code should go into the <code>.cpp</code> file and not the <code>.h</code>, unless necessary due to template usage or when performance due to inlining is critical<ul>
<li><em>Rationale</em>: Shorter and simpler header files are easier to read, and reduce compile time</li>
</ul>
</li>
<li>Use only the lowercase alphanumerics (<code>a-z0-9</code>), underscore (<code>_</code>) and hyphen (<code>-</code>) in source code filenames.<ul>
<li><em>Rationale</em>: <code>grep</code>:ing and auto-completing filenames is easier when using a consistent naming pattern. Potential problems when building on case-insensitive filesystems are avoided when using only lowercase characters in source code filenames.</li>
</ul>
</li>
<li>Every <code>.cpp</code> and <code>.h</code> file should <code>#include</code> every header file it directly uses classes, functions or other definitions from, even if those headers are already included indirectly through other headers.<ul>
<li><em>Rationale</em>: Excluding headers because they are already indirectly included results in compilation failures when those indirect dependencies change. Furthermore, it obscures what the real code dependencies are.</li>
</ul>
</li>
<li>Don't import anything into the global namespace (<code>using namespace ...</code>). Use fully specified types such as <code>std::string</code>.<ul>
<li><em>Rationale</em>: Avoids symbol conflicts</li>
</ul>
</li>
<li>Terminate namespaces with a comment (<code>// namespace mynamespace</code>). The comment should be placed on the same line as the brace closing the namespace, e.g.</li>
</ul>
<div class="fragment"><div class="line"> {c++}</div><div class="line">namespace mynamespace {</div><div class="line">...</div><div class="line">} // namespace mynamespace</div><div class="line"></div><div class="line">namespace {</div><div class="line">...</div><div class="line">} // namespace</div></div><!-- fragment --><ul>
<li><em>Rationale</em>: Avoids confusion about the namespace context</li>
</ul>
<p>Use <code>#include &lt;<a class="el" href="../../dc/d1c/primitives_2transaction_8h.html">primitives/transaction.h</a>&gt;</code> bracket syntax instead of <code>#include "primitives/transactions.h"</code> quote syntax.</p>
<ul>
<li><em>Rationale</em>: Bracket syntax is less ambiguous because the preprocessor searches a fixed list of include directories without taking location of the source file into account. This allows quoted includes to stand out more when the location of the source file actually is relevant.</li>
</ul>
<p>Use include guards to avoid the problem of double inclusion. The header file <code>foo/bar.h</code> should use the include guard identifier <code>BITCOIN_FOO_BAR_H</code>, e.g.</p>
<div class="fragment"><div class="line"> {c++}</div><div class="line">#ifndef BITCOIN_FOO_BAR_H</div><div class="line">#define BITCOIN_FOO_BAR_H</div><div class="line">...</div><div class="line">#endif // BITCOIN_FOO_BAR_H</div></div><!-- fragment --><h2>GUI </h2>
<ul>
<li>Do not display or manipulate dialogs in model code (classes <code>*Model</code>)<ul>
<li><em>Rationale</em>: Model classes pass through events and data from the core, they should not interact with the user. That's where View classes come in. The converse also holds: try to not directly access core data structures from Views.</li>
</ul>
</li>
<li><p class="startli">Avoid adding slow or blocking code in the GUI thread. In particular do not add new <code><a class="el" href="../../d5/df4/classinterfaces_1_1Node.html" title="Top-level interface for a bitcoin node (bitcoind process).">interfaces::Node</a></code> and <code><a class="el" href="../../d9/d15/classinterfaces_1_1Wallet.html" title="Interface for accessing a wallet.">interfaces::Wallet</a></code> method calls, even if they may be fast now, in case they are changed to lock or communicate across processes in the future.</p>
<p class="startli">Prefer to offload work from the GUI thread to worker threads (see <code><a class="el" href="../../d2/dd2/classRPCExecutor.html">RPCExecutor</a></code> in console code as an example) or take other steps (see <a href="https://doc.qt.io/archives/qq/qq27-responsive-guis.html">https://doc.qt.io/archives/qq/qq27-responsive-guis.html</a>) to keep the GUI responsive.</p><ul>
<li><em>Rationale</em>: Blocking the GUI thread can increase latency, and lead to hangs and deadlocks.</li>
</ul>
</li>
</ul>
<h2>Subtrees </h2>
<p>Several parts of the repository are subtrees of software maintained elsewhere.</p>
<p>Some of these are maintained by active developers of Bitcoin Core, in which case changes should probably go directly upstream without being PRed directly against the project. They will be merged back in the next subtree merge.</p>
<p>Others are external projects without a tight relationship with our project. Changes to these should also be sent upstream but bugfixes may also be prudent to PR against Bitcoin Core so that they can be integrated quickly. Cosmetic changes should be purely taken upstream.</p>
<p>There is a tool in <code>test/lint/git-subtree-check.sh</code> to check a subtree directory for consistency with its upstream repository.</p>
<p>Current subtrees include:</p>
<ul>
<li>src/leveldb<ul>
<li>Upstream at <a href="https://github.com/google/leveldb">https://github.com/google/leveldb</a> ; Maintained by Google, but open important PRs to Core to avoid delay.</li>
<li><b>Note</b>: Follow the instructions in <a href="../../#upgrading-leveldb">Upgrading LevelDB</a> when merging upstream changes to the LevelDB subtree.</li>
</ul>
</li>
<li>src/libsecp256k1<ul>
<li>Upstream at <a href="https://github.com/bitcoin-core/secp256k1/">https://github.com/bitcoin-core/secp256k1/</a> ; actively maintained by Core contributors.</li>
</ul>
</li>
<li>src/crypto/ctaes<ul>
<li>Upstream at <a href="https://github.com/bitcoin-core/ctaes">https://github.com/bitcoin-core/ctaes</a> ; actively maintained by Core contributors.</li>
</ul>
</li>
<li>src/univalue<ul>
<li>Upstream at <a href="https://github.com/bitcoin-core/univalue">https://github.com/bitcoin-core/univalue</a> ; actively maintained by Core contributors, deviates from upstream <a href="https://github.com/jgarzik/univalue">https://github.com/jgarzik/univalue</a></li>
</ul>
</li>
</ul>
<h2>Upgrading LevelDB </h2>
<p>Extra care must be taken when upgrading LevelDB. This section explains issues you must be aware of.</p>
<h3>File <a class="el" href="../../d3/de6/structDescriptor.html">Descriptor</a> Counts</h3>
<p>In most configurations we use the default LevelDB value for <code>max_open_files</code>, which is 1000 at the time of this writing. If LevelDB actually uses this many file descriptors it will cause problems with Bitcoin's <code>select()</code> loop, because it may cause new sockets to be created where the fd value is &gt;= 1024. For this reason, on 64-bit Unix systems we rely on an internal LevelDB optimization that uses <code>mmap()</code> + <code>close()</code> to open table files without actually retaining references to the table file descriptors. If you are upgrading LevelDB, you must sanity check the changes to make sure that this assumption remains valid.</p>
<p>In addition to reviewing the upstream changes in <code><a class="el" href="../../de/d24/env__posix_8cc.html">env_posix.cc</a></code>, you can use <code>lsof</code> to check this. For example, on Linux this command will show open <code>.ldb</code> file counts:</p>
<div class="fragment"><div class="line">$ lsof -p $(pidof bitcoind) |\</div><div class="line">    awk &#39;BEGIN { fd=0; mem=0; } /ldb$/ { if ($4 == &quot;mem&quot;) mem++; else fd++ } END { printf &quot;mem = %s, fd = %s\n&quot;, mem, fd}&#39;</div><div class="line">mem = 119, fd = 0</div></div><!-- fragment --><p>The <code>mem</code> value shows how many files are mmap'ed, and the <code>fd</code> value shows you many file descriptors these files are using. You should check that <code>fd</code> is a small number (usually 0 on 64-bit hosts).</p>
<p>See the notes in the <code><a class="el" href="../../d7/d18/dbwrapper_8cpp.html#a4b427f49edec408ed90d9e39c08e8ba8">SetMaxOpenFiles()</a></code> function in <code>dbwrapper.cc</code> for more details.</p>
<h3><a class="el" href="../../d8/d27/namespaceConsensus.html">Consensus</a> Compatibility</h3>
<p>It is possible for LevelDB changes to inadvertently change consensus compatibility between nodes. This happened in Bitcoin 0.8 (when LevelDB was first introduced). When upgrading LevelDB you should review the upstream changes to check for issues affecting consensus compatibility.</p>
<p>For example, if LevelDB had a bug that accidentally prevented a key from being returned in an edge case, and that bug was fixed upstream, the bug "fix" would be an incompatible consensus change. In this situation the correct behavior would be to revert the upstream fix before applying the updates to Bitcoin's copy of LevelDB. In general you should be wary of any upstream changes affecting what data is returned from LevelDB queries.</p>
<h2>Scripted diffs </h2>
<p>For reformatting and refactoring commits where the changes can be easily automated using a bash script, we use scripted-diff commits. The bash script is included in the commit message and our Travis CI job checks that the result of the script is identical to the commit. This aids reviewers since they can verify that the script does exactly what it's supposed to do. It is also helpful for rebasing (since the same script can just be re-run on the new master commit).</p>
<p>To create a scripted-diff:</p>
<ul>
<li>start the commit message with <code>scripted-diff:</code> (and then a description of the diff on the same line)</li>
<li>in the commit message include the bash script between lines containing just the following text:<ul>
<li><code>-BEGIN VERIFY SCRIPT-</code></li>
<li><code>-END VERIFY SCRIPT-</code></li>
</ul>
</li>
</ul>
<p>The scripted-diff is verified by the tool <code>test/lint/commit-script-check.sh</code>. The tool's default behavior when supplied with a commit is to verify all scripted-diffs from the beginning of time up to said commit. Internally, the tool passes the first supplied argument to <code>git rev-list --reverse</code> to determine which commits to verify script-diffs for, ignoring commits that don't conform to the commit message format described above.</p>
<p>For development, it might be more convenient to verify all scripted-diffs in a range <code>A..B</code>, for example:</p>
<div class="fragment"><div class="line">test/lint/commit-script-check.sh origin/master..HEAD</div></div><!-- fragment --><p>Commit <a href="https://github.com/bitcoin/bitcoin/commit/bb81e173"><code>bb81e173</code></a> is an example of a scripted-diff.</p>
<h2>Release notes </h2>
<p>Release notes should be written for any PR that:</p>
<ul>
<li>introduces a notable new feature</li>
<li>fixes a significant bug</li>
<li>changes an API or configuration model</li>
<li>makes any other visible change to the end-user experience.</li>
</ul>
<p>Release notes should be added to a PR-specific release note file at <code>/doc/release-notes-&lt;PR number&gt;.md</code> to avoid conflicts between multiple PRs. All <code>release-notes*</code> files are merged into a single <a class="el" href="../../d0/df4/release-notes_8md.html">/doc/release-notes.md</a> file prior to the release.</p>
<h2>RPC interface guidelines </h2>
<p>A few guidelines for introducing and reviewing new RPC interfaces:</p>
<ul>
<li>Method naming: use consecutive lower-case names such as <code>getrawtransaction</code> and <code>submitblock</code><ul>
<li><em>Rationale</em>: Consistency with existing interface.</li>
</ul>
</li>
<li>Argument naming: use snake case <code>fee_delta</code> (and not, e.g. camel case <code>feeDelta</code>)<ul>
<li><em>Rationale</em>: Consistency with existing interface.</li>
</ul>
</li>
<li>Use the JSON parser for parsing, don't manually parse integers or strings from arguments unless absolutely necessary.<ul>
<li><em>Rationale</em>: Introduces hand-rolled string manipulation code at both the caller and callee sites, which is error prone, and it is easy to get things such as escaping wrong. JSON already supports nested data structures, no need to re-invent the wheel.</li>
<li><em>Exception</em>: AmountFromValue can parse amounts as string. This was introduced because many JSON parsers and formatters hard-code handling decimal numbers as floating point values, resulting in potential loss of precision. This is unacceptable for monetary values. <b>Always</b> use <code>AmountFromValue</code> and <code>ValueFromAmount</code> when inputting or outputting monetary values. The only exceptions to this are <code>prioritisetransaction</code> and <code>getblocktemplate</code> because their interface is specified as-is in BIP22.</li>
</ul>
</li>
<li>Missing arguments and 'null' should be treated the same: as default values. If there is no default value, both cases should fail in the same way. The easiest way to follow this guideline is detect unspecified arguments with <code>params[x].isNull()</code> instead of <code>params.size() &lt;= x</code>. The former returns true if the argument is either null or missing, while the latter returns true if is missing, and false if it is null.<ul>
<li><em>Rationale</em>: Avoids surprises when switching to name-based arguments. Missing name-based arguments are passed as 'null'.</li>
</ul>
</li>
<li>Try not to overload methods on argument type. E.g. don't make <code>getblock(true)</code> and <code>getblock("hash")</code> do different things.<ul>
<li><em>Rationale</em>: This is impossible to use with <code>bitcoin-cli</code>, and can be surprising to users.</li>
<li><em>Exception</em>: Some RPC calls can take both an <code>int</code> and <code>bool</code>, most notably when a bool was switched to a multi-value, or due to other historical reasons. <b>Always</b> have false map to 0 and true to 1 in this case.</li>
</ul>
</li>
<li>Don't forget to fill in the argument names correctly in the RPC command table.<ul>
<li><em>Rationale</em>: If not, the call can not be used with name-based arguments.</li>
</ul>
</li>
<li>Set okSafeMode in the RPC command table to a sensible value: safe mode is when the blockchain is regarded to be in a confused state, and the client deems it unsafe to do anything irreversible such as send. Anything that just queries should be permitted.<ul>
<li><em>Rationale</em>: Troubleshooting a node in safe mode is difficult if half the RPCs don't work.</li>
</ul>
</li>
<li>Add every non-string RPC argument <code>(method, idx, name)</code> to the table <code>vRPCConvertParams</code> in <code><a class="el" href="../../d9/d95/client_8cpp.html">rpc/client.cpp</a></code>.<ul>
<li><em>Rationale</em>: <code>bitcoin-cli</code> and the GUI debug console use this table to determine how to convert a plaintext command line to JSON. If the types don't match, the method can be unusable from there.</li>
</ul>
</li>
<li>A RPC method must either be a wallet method or a non-wallet method. Do not introduce new methods that differ in behavior based on presence of a wallet.<ul>
<li><em>Rationale</em>: as well as complicating the implementation and interfering with the introduction of multi-wallet, wallet and non-wallet code should be separated to avoid introducing circular dependencies between code units.</li>
</ul>
</li>
<li>Try to make the RPC response a JSON object.<ul>
<li><em>Rationale</em>: If a RPC response is not a JSON object then it is harder to avoid API breakage if new data in the response is needed.</li>
</ul>
</li>
<li>Wallet RPCs call BlockUntilSyncedToCurrentChain to maintain consistency with <code>getblockchaininfo</code>'s state immediately prior to the call's execution. Wallet RPCs whose behavior does <em>not</em> depend on the current chainstate may omit this call.<ul>
<li><em>Rationale</em>: In previous versions of Bitcoin Core, the wallet was always in-sync with the chainstate (by virtue of them all being updated in the same cs_main lock). In order to maintain the behavior that wallet RPCs return results as of at least the highest best-known block an RPC client may be aware of prior to entering a wallet RPC call, we must block until the wallet is caught up to the chainstate as of the RPC call's entry. This also makes the API much easier for RPC clients to reason about.</li>
</ul>
</li>
<li>Be aware of RPC method aliases and generally avoid registering the same callback function pointer for different RPCs.<ul>
<li><em>Rationale</em>: RPC methods registered with the same function pointer will be considered aliases and only the first method name will show up in the <code>help</code> rpc command list.</li>
<li><em>Exception</em>: Using RPC method aliases may be appropriate in cases where a new RPC is replacing a deprecated RPC, to avoid both RPCs confusingly showing up in the command list. </li>
</ul>
</li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
