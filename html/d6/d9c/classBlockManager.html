<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bitcoin: BlockManager Class Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bitcoin
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-attribs">Public Attributes</a> &#124;
<a href="../../d6/d35/classBlockManager-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">BlockManager Class Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p><code>#include &lt;<a class="el" href="../../db/d38/validation_8h_source.html">validation.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a43f18ff5266d6c3640e51b210e21a016"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../db/d38/validation_8h.html#a6b962fe256607627c8140021ae7a23e1">BlockMap</a> m_block_index&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/d9c/classBlockManager.html#a43f18ff5266d6c3640e51b210e21a016">GUARDED_BY</a> (<a class="el" href="../../de/d35/validationinterface_8h.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</td></tr>
<tr class="separator:a43f18ff5266d6c3640e51b210e21a016"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5fab68e383529ca408eb24e808840c08"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/d9c/classBlockManager.html#a5fab68e383529ca408eb24e808840c08">LoadBlockIndex</a> (const <a class="el" href="../../da/d55/structConsensus_1_1Params.html">Consensus::Params</a> &amp;consensus_params, <a class="el" href="../../d6/d80/classCBlockTreeDB.html">CBlockTreeDB</a> &amp;blocktree, std::set&lt; <a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a> *, <a class="el" href="../../df/dd8/structCBlockIndexWorkComparator.html">CBlockIndexWorkComparator</a> &gt; &amp;block_index_candidates) <a class="el" href="../../db/d6d/threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="el" href="../../de/d35/validationinterface_8h.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</td></tr>
<tr class="separator:a5fab68e383529ca408eb24e808840c08"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a48ee023e5949eaed5a9ed4f3da085957"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/d9c/classBlockManager.html#a48ee023e5949eaed5a9ed4f3da085957">Unload</a> () <a class="el" href="../../db/d6d/threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="el" href="../../de/d35/validationinterface_8h.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</td></tr>
<tr class="separator:a48ee023e5949eaed5a9ed4f3da085957"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0af7433d0d6ba39b377d83eed19c66d1"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/d9c/classBlockManager.html#a0af7433d0d6ba39b377d83eed19c66d1">AddToBlockIndex</a> (const <a class="el" href="../../d2/d93/classCBlockHeader.html">CBlockHeader</a> &amp;block) <a class="el" href="../../db/d6d/threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="el" href="../../de/d35/validationinterface_8h.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</td></tr>
<tr class="separator:a0af7433d0d6ba39b377d83eed19c66d1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a00017eed035cc0708fc9355419128fcd"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/d9c/classBlockManager.html#a00017eed035cc0708fc9355419128fcd">InsertBlockIndex</a> (const <a class="el" href="../../d2/d86/classuint256.html">uint256</a> &amp;hash) <a class="el" href="../../db/d6d/threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="el" href="../../de/d35/validationinterface_8h.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</td></tr>
<tr class="separator:a00017eed035cc0708fc9355419128fcd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd571a24b7ef2fb41a5bdceeda57cc6d"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/d9c/classBlockManager.html#acd571a24b7ef2fb41a5bdceeda57cc6d">AcceptBlockHeader</a> (const <a class="el" href="../../d2/d93/classCBlockHeader.html">CBlockHeader</a> &amp;block, <a class="el" href="../../d4/d71/classCValidationState.html">CValidationState</a> &amp;state, const <a class="el" href="../../df/d9b/classCChainParams.html">CChainParams</a> &amp;chainparams, <a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a> **ppindex) <a class="el" href="../../db/d6d/threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="el" href="../../de/d35/validationinterface_8h.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</td></tr>
<tr class="separator:acd571a24b7ef2fb41a5bdceeda57cc6d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-attribs"></a>
Public Attributes</h2></td></tr>
<tr class="memitem:a225bfa76e7e892fa9b215b724aea6227"><td class="memItemLeft" align="right" valign="top">std::set&lt; <a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a> * &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/d9c/classBlockManager.html#a225bfa76e7e892fa9b215b724aea6227">m_failed_blocks</a></td></tr>
<tr class="separator:a225bfa76e7e892fa9b215b724aea6227"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeefcdf3e848895712b5011410918b65b"><td class="memItemLeft" align="right" valign="top">std::multimap&lt; <a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a> *, <a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a> * &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/d9c/classBlockManager.html#aeefcdf3e848895712b5011410918b65b">m_blocks_unlinked</a></td></tr>
<tr class="separator:aeefcdf3e848895712b5011410918b65b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Maintains a tree of blocks (stored in <code>m_block_index</code>) which is consulted to determine where the most-work tip is.</p>
<p>This data is used mostly in <code><a class="el" href="../../d3/d9b/classCChainState.html">CChainState</a></code> - information about, e.g., candidate tips is not maintained here. </p>
</div><h2 class="groupheader">Member Function Documentation</h2>
<a id="acd571a24b7ef2fb41a5bdceeda57cc6d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acd571a24b7ef2fb41a5bdceeda57cc6d">&#9670;&nbsp;</a></span>AcceptBlockHeader()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool BlockManager::AcceptBlockHeader </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="../../d2/d93/classCBlockHeader.html">CBlockHeader</a> &amp;&#160;</td>
          <td class="paramname"><em>block</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d4/d71/classCValidationState.html">CValidationState</a> &amp;&#160;</td>
          <td class="paramname"><em>state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="../../df/d9b/classCChainParams.html">CChainParams</a> &amp;&#160;</td>
          <td class="paramname"><em>chainparams</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a> **&#160;</td>
          <td class="paramname"><em>ppindex</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>If a block header hasn't already been seen, call CheckBlockHeader on it, ensure that it doesn't descend from an invalid block, and then add it to m_block_index. </p>

</div>
</div>
<a id="a0af7433d0d6ba39b377d83eed19c66d1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0af7433d0d6ba39b377d83eed19c66d1">&#9670;&nbsp;</a></span>AddToBlockIndex()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a> * BlockManager::AddToBlockIndex </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="../../d2/d93/classCBlockHeader.html">CBlockHeader</a> &amp;&#160;</td>
          <td class="paramname"><em>block</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a43f18ff5266d6c3640e51b210e21a016"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a43f18ff5266d6c3640e51b210e21a016">&#9670;&nbsp;</a></span>GUARDED_BY()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../db/d38/validation_8h.html#a6b962fe256607627c8140021ae7a23e1">BlockMap</a> m_block_index BlockManager::GUARDED_BY </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="../../de/d35/validationinterface_8h.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a00017eed035cc0708fc9355419128fcd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a00017eed035cc0708fc9355419128fcd">&#9670;&nbsp;</a></span>InsertBlockIndex()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a> * BlockManager::InsertBlockIndex </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="../../d2/d86/classuint256.html">uint256</a> &amp;&#160;</td>
          <td class="paramname"><em>hash</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Create a new block index entry for a given block hash </p>

</div>
</div>
<a id="a5fab68e383529ca408eb24e808840c08"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5fab68e383529ca408eb24e808840c08">&#9670;&nbsp;</a></span>LoadBlockIndex()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool BlockManager::LoadBlockIndex </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="../../da/d55/structConsensus_1_1Params.html">Consensus::Params</a> &amp;&#160;</td>
          <td class="paramname"><em>consensus_params</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d6/d80/classCBlockTreeDB.html">CBlockTreeDB</a> &amp;&#160;</td>
          <td class="paramname"><em>blocktree</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::set&lt; <a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a> *, <a class="el" href="../../df/dd8/structCBlockIndexWorkComparator.html">CBlockIndexWorkComparator</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>block_index_candidates</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Load the blocktree off disk and into memory. Populate certain metadata per index entry (nStatus, nChainWork, nTimeMax, etc.) as well as peripheral collections like setDirtyBlockIndex.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[out]</td><td class="paramname">block_index_candidates</td><td>Fill this set with any valid blocks for which we've downloaded all transactions. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a48ee023e5949eaed5a9ed4f3da085957"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a48ee023e5949eaed5a9ed4f3da085957">&#9670;&nbsp;</a></span>Unload()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void BlockManager::Unload </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Clear all data members. </p>

</div>
</div>
<h2 class="groupheader">Member Data Documentation</h2>
<a id="aeefcdf3e848895712b5011410918b65b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aeefcdf3e848895712b5011410918b65b">&#9670;&nbsp;</a></span>m_blocks_unlinked</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::multimap&lt;<a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a>*, <a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a>*&gt; BlockManager::m_blocks_unlinked</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>All pairs A-&gt;B, where A (or one of its ancestors) misses transactions, but B has transactions. Pruned nodes may have entries where B is missing data. </p>

</div>
</div>
<a id="a225bfa76e7e892fa9b215b724aea6227"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a225bfa76e7e892fa9b215b724aea6227">&#9670;&nbsp;</a></span>m_failed_blocks</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::set&lt;<a class="el" href="../../d8/df0/classCBlockIndex.html">CBlockIndex</a>*&gt; BlockManager::m_failed_blocks</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>In order to efficiently track invalidity of headers, we keep the set of blocks which we tried to connect and found to be invalid here (ie which were set to BLOCK_FAILED_VALID since the last restart). We can then walk this set and check if a new header is a descendant of something in this set, preventing us from having to walk m_block_index when we try to connect a bad block and fail.</p>
<p>While this is more complicated than marking everything which descends from an invalid block as invalid at the time we discover it to be invalid, doing so would require walking all of m_block_index to find all descendants. Since this case should be very rare, keeping track of all BLOCK_FAILED_VALID blocks in a set should be just fine and work just as well.</p>
<p>Because we already walk m_block_index in height-order at startup, we go ahead and mark descendants of invalid blocks as FAILED_CHILD at that time, instead of putting things in this set. </p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>src/<a class="el" href="../../db/d38/validation_8h_source.html">validation.h</a></li>
<li>src/<a class="el" href="../../dd/d7d/validation_8cpp.html">validation.cpp</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
