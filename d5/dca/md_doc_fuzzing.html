<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bitcoin: Fuzz-testing Bitcoin Core</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bitcoin
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Fuzz-testing Bitcoin Core </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A special test harness in <code>src/test/fuzz/</code> is provided for each fuzz target to provide an easy entry point for fuzzers and the like. In this document we'll describe how to use it with AFL and libFuzzer.</p>
<h2>Preparing fuzzing</h2>
<p>AFL needs an input directory with examples, and an output directory where it will place examples that it found. These can be anywhere in the file system, we'll define environment variables to make it easy to reference them.</p>
<p>libFuzzer will use the input directory as output directory.</p>
<p>Extract the example seeds (or other starting inputs) into the inputs directory before starting fuzzing.</p>
<div class="fragment"><div class="line">git clone https://github.com/bitcoin-core/qa-assets</div><div class="line">export DIR_FUZZ_IN=$PWD/qa-assets/fuzz_seed_corpus</div></div><!-- fragment --><p>Only for AFL:</p>
<div class="fragment"><div class="line">mkdir outputs</div><div class="line">export AFLOUT=$PWD/outputs</div></div><!-- fragment --><h2>AFL</h2>
<h3>Building AFL</h3>
<p>It is recommended to always use the latest version of afl: </p><div class="fragment"><div class="line">wget http://lcamtuf.coredump.cx/afl/releases/afl-latest.tgz</div><div class="line">tar -zxvf afl-latest.tgz</div><div class="line">cd afl-&lt;version&gt;</div><div class="line">make</div><div class="line">export AFLPATH=$PWD</div></div><!-- fragment --><h3>Instrumentation</h3>
<p>To build Bitcoin Core using AFL instrumentation (this assumes that the <code>AFLPATH</code> was set as above): </p><div class="fragment"><div class="line">./configure --disable-ccache --disable-shared --enable-tests --enable-fuzz --disable-wallet --disable-bench --with-utils=no --with-daemon=no --with-libs=no --with-gui=no CC=${AFLPATH}/afl-gcc CXX=${AFLPATH}/afl-g++</div><div class="line">export AFL_HARDEN=1</div><div class="line">cd src/</div><div class="line">make</div></div><!-- fragment --><p> We disable ccache because we don't want to pollute the ccache with instrumented objects, and similarly don't want to use non-instrumented cached objects linked in.</p>
<p>The fuzzing can be sped up significantly (~200x) by using <code>afl-clang-fast</code> and <code>afl-clang-fast++</code> in place of <code>afl-gcc</code> and <code>afl-g++</code> when compiling. When compiling using <code>afl-clang-fast</code>/<code>afl-clang-fast++</code> the resulting binary will be instrumented in such a way that the AFL features "persistent mode" and "deferred forkserver" can be used. See <a href="https://github.com/mcarpenter/afl/tree/master/llvm_mode">https://github.com/mcarpenter/afl/tree/master/llvm_mode</a> for details.</p>
<h3>Fuzzing</h3>
<p>To start the actual fuzzing use:</p>
<div class="fragment"><div class="line">export FUZZ_TARGET=fuzz_target_foo  # Pick a fuzz_target</div><div class="line">mkdir ${AFLOUT}/${FUZZ_TARGET}</div><div class="line">$AFLPATH/afl-fuzz -i ${DIR_FUZZ_IN}/${FUZZ_TARGET} -o ${AFLOUT}/${FUZZ_TARGET} -m52 -- test/fuzz/${FUZZ_TARGET}</div></div><!-- fragment --><p>You may have to change a few kernel parameters to test optimally - <code>afl-fuzz</code> will print an error and suggestion if so.</p>
<h2>libFuzzer</h2>
<p>A recent version of <code>clang</code>, the address sanitizer and libFuzzer is needed (all found in the <code>compiler-rt</code> runtime libraries package).</p>
<p>To build all fuzz targets with libFuzzer, run</p>
<div class="fragment"><div class="line">./configure --disable-ccache --disable-wallet --disable-bench --with-utils=no --with-daemon=no --with-libs=no --with-gui=no --enable-fuzz --with-sanitizers=fuzzer,address CC=clang CXX=clang++</div><div class="line">make</div></div><!-- fragment --><p>The fuzzer needs some inputs to work on, but the inputs or seeds can be used interchangeably between libFuzzer and AFL.</p>
<p>See <a href="https://llvm.org/docs/LibFuzzer.html#running">https://llvm.org/docs/LibFuzzer.html#running</a> on how to run the libFuzzer instrumented executable.</p>
<p>Alternatively run the script in <code>./test/fuzz/test_runner.py</code> and provide it with the <code>${DIR_FUZZ_IN}</code> created earlier. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
